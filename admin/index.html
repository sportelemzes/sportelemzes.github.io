<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8">
  <title>Admin – SportElemzés</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --bg:#0b0b0b;--panel:#141414;--muted:#1e1e1e;--txt:#e6e6e6;--sub:#aab3c0;
      --brand:#00e5a8;--warn:#ff6b6b;--ok:#58d68d;--link:#7cc7ff;
    }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:28px 16px}
    h1{font-weight:800;letter-spacing:.2px} h2{margin-top:28px}
    .card{background:var(--panel);border:1px solid #222;border-radius:12px;padding:16px;margin:18px 0;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    label{display:block;font-size:.9rem;color:var(--sub);margin:10px 0 6px}
    input[type=text],input[type=datetime-local],input[type=number],select,textarea{
      width:100%;background:#0e0e0f;color:var(--txt);border:1px solid #2b2b2b;border-radius:8px;padding:10px 12px;outline:0
    }
    textarea{min-height:160px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{cursor:pointer;background:#222;color:var(--txt);border:1px solid #333;border-radius:10px;padding:10px 14px;font-weight:700}
    .btn.brand{background:var(--brand);border-color:var(--brand);color:#06271c}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
    .muted{color:#8a97a6}
    .msg{margin-top:10px;font-weight:700}
    .ok{color:var(--ok)} .err{color:var(--warn)}
    a{color:var(--link)}
    .small{font-size:.85rem}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .note{font-size:.85rem;color:#9aa6b4}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin</h1>
    <p class="muted small">Gyors közzététel GitHub API-val (nincs szerver). – A „Kezdés” mező <b>helyi idő</b> (CET/CEST),
      mentéskor a rendszer <b>UTC-re</b> konvertálja.</p>

    <!-- TOKEN -->
    <section class="card">
      <h2>Token</h2>
      <p class="note">Fine-grained token: csak ehhez a rephoz, <i>Repository contents: Read/Write</i>. A böngésződ LocalStorage-ében marad.</p>
      <div class="row">
        <div>
          <label>Token</label>
          <input id="tok" type="text" placeholder="ghp_xxx…">
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn" id="saveTok">Token mentése</button>
        </div>
      </div>
      <div id="msgTok" class="msg"></div>
    </section>

    <!-- CIKK + TIPP EGYBEN -->
    <section class="card">
      <h2>Cikk + Tipp (1 klikk)</h2>
      <p class="note">A gomb <b>létrehozza a cikket</b>, frissíti a <code>posts/index.json</code>-t, és <b>hozzáadja a tippet</b> a
        <code>data/picks.json</code>-hoz ugyanazzal a <code>postSlug</code>-gal.</p>

      <div class="row">
        <div>
          <label>Cím</label>
          <input id="title" type="text" placeholder="Pl. Newcastle vs Liverpool – elemzés és tipp">
        </div>
        <div>
          <label>Dátum (cikk fejléc)</label>
          <input id="postDate" type="date">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Liga / sport (opcionális)</label>
          <input id="league" type="text" placeholder="EPL / Foci">
        </div>
        <div>
          <label>Rövid kivonat</label>
          <input id="excerpt" type="text" placeholder="1–2 mondatban a lényeg">
        </div>
      </div>
      <label>Cikk szövege (HTML vagy sima szöveg)</label>
      <textarea id="body" placeholder="Írd ide a cikket…"></textarea>

      <div class="row">
        <div>
          <label>Slug (ha üres, a cím + dátum alapján készül)</label>
          <input id="slug" type="text" placeholder="2025-08-25-newcastle-liverpool">
        </div>
        <div>
          <label>Kezdés (helyi idő, CET/CEST)</label>
          <input id="kick" type="datetime-local">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Meccs / Event név (pl. teljes név)</label>
          <input id="eventName" type="text" placeholder="Newcastle – Liverpool">
        </div>
        <div>
          <label>Event ID / alias</label>
          <input id="eventId" type="text" placeholder="NEW-LIV">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Piac</label>
          <select id="market">
            <option value="h2h">h2h (1x2)</option>
            <option value="totals">totals (o/u)</option>
            <option value="asian_handicap">asian_handicap (AH)</option>
          </select>
        </div>
        <div>
          <label>Vonal (totals/AH esetén)</label>
          <input id="line" type="number" step="0.01" placeholder="pl. 0.0, 2.5">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Választás</label>
          <input id="sel" type="text" placeholder="home / draw / away vagy over / under">
        </div>
        <div>
          <label>Odds</label>
          <input id="odds" type="number" step="0.01" placeholder="pl. 2.24">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Tét</label>
          <input id="stake" type="number" step="1" value="1000">
        </div>
        <div>
          <label>Kezdeti státusz</label>
          <select id="status">
            <option value="open" selected>open</option>
            <option value="won">won</option>
            <option value="lost">lost</option>
            <option value="void">void</option>
          </select>
        </div>
      </div>

      <div class="bar">
        <button class="btn brand" id="publishAll">Cikk közzététele + Tipp mentése</button>
        <button class="btn" id="publishOnly">Csak cikk közzététele</button>
        <button class="btn" id="tipOnly">Csak tipp mentése</button>
      </div>
      <div id="msg" class="msg"></div>
    </section>

    <p class="small muted">Repo: <code>sportelemzes/sportelemzes.github.io</code>. Fájlok: <code>posts/*.html</code>,
      <code>posts/index.json</code>, <code>data/picks.json</code>.</p>
  </div>

<script>
/*** ------- ÁLLÍTHATÓ KONFIG ------- ***/
const OWNER  = 'sportelemzes';
const REPO   = 'sportelemzes.github.io';
const BRANCH = 'main';

/*** ------- KISEGÍTŐK ------- ***/
const $ = sel => document.querySelector(sel);
const msg  = (id, t, ok=true)=>{ const el=$(id); el.textContent=t; el.className='msg '+(ok?'ok':'err'); };
const b64  = s=> btoa(unescape(encodeURIComponent(s)));
const unb64= s=> decodeURIComponent(escape(atob(s)));

const todayISODate = ()=> new Date().toISOString().slice(0,10);
$('#postDate').value = todayISODate();

/** slug */
function makeSlug(title, date){
  const t = title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  return `${(date||todayISODate())}-${t}`.replace(/-+/g,'-');
}

/** datetime-local (helyi) -> ISO UTC Z */
function toISOZ(localStr){
  if(!localStr) return '';
  const d = new Date(localStr);          // helyi idő
  return d.toISOString();                 // UTC-re konvertálva (ISOZ)
}

/*** ------- GITHUB API ------- ***/
function ghHeaders(){
  const token = localStorage.getItem('gh_token');
  if(!token) throw new Error('Hiányzik a token. Add meg fent és mentsd el.');
  return { 'Authorization':'token '+token, 'Accept':'application/vnd.github+json' };
}
async function ghGet(path){
  const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`, {headers:ghHeaders()});
  if(!r.ok) throw new Error('GET hiba: '+r.status+' '+path);
  const j = await r.json();
  return { sha:j.sha, text: unb64(j.content||'') };
}
async function ghPut(path, content, message){
  // kell hozzá az aktuális sha (ha van)
  let sha=null;
  try{ const g=await ghGet(path); sha=g.sha; }catch(_){}
  const body = { message, content:b64(content), branch:BRANCH };
  if(sha) body.sha=sha;
  const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
    method:'PUT', headers:{...ghHeaders(),'Content-Type':'application/json'}, body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error('PUT hiba: '+r.status+' '+path);
}

/*** ------- TOKEN ------- ***/
$('#saveTok').onclick = ()=>{
  const t = $('#tok').value.trim();
  if(!t){ msg('#msgTok','Adj meg egy token-t!',false); return; }
  localStorage.setItem('gh_token', t);
  msg('#msgTok','Token elmentve.',true);
};
window.addEventListener('DOMContentLoaded', ()=>{
  const t = localStorage.getItem('gh_token'); if(t) $('#tok').value=t;
});

/*** ------- CIKK HTML GENERÁLÁS ------- ***/
function renderPostHTML({title,postDate,league,excerpt,body,slug}){
  const lig = league ? ` • ${league}` : '';
  const safeBody = body || '';
  return `<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8">
  <title>${title}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/assets/style.css">
  <script src="/assets/site.js" defer></script>
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemzés</span></a>
    <div class="links">
      <a href="/">Elemzések</a>
      <a href="/stats.html">Statisztika</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>${title}</h1>
    <p>${postDate}${lig}</p>
  </div>
</header>

<main>
  <section class="card">
    <h2>Összefoglaló</h2>
    <p>${excerpt||''}</p>
    ${safeBody}
  </section>
</main>

<footer class="muted" style="text-align:center;padding:24px 0">
  <div class="links">
    <a href="/">Elemzések</a>
    <a href="/stats.html">Statisztika</a>
    <a href="/privacy.html">Adatkezelés</a>
  </div>
</footer>
</body>
</html>`;
}

/*** ------- MENTÉS LÉPÉSEI ------- ***/
async function savePost(){
  const title = $('#title').value.trim();
  const postDate = $('#postDate').value || todayISODate();
  const league = $('#league').value.trim();
  const excerpt= $('#excerpt').value.trim();
  const body   = $('#body').value.trim();
  let slug     = $('#slug').value.trim();

  if(!title){ throw new Error('Hiányzik a cím.'); }
  if(!slug) slug = makeSlug(title, postDate);

  // 1) posts/slug.html
  const html = renderPostHTML({title,postDate,league,excerpt,body,slug});
  await ghPut(`posts/${slug}.html`, html, `Add post: ${title}`);

  // 2) posts/index.json
  let idx = [];
  try{ const {text} = await ghGet('posts/index.json'); idx = JSON.parse(text); }catch(_){ idx=[]; }
  idx = Array.isArray(idx)? idx : [];
  // távolítsuk el ha már létezett ugyanezzel a sluggal
  idx = idx.filter(x=>x.slug!==slug);
  idx.unshift({ title, date: postDate, league, slug });
  await ghPut('posts/index.json', JSON.stringify(idx,null,2), 'Update posts index');

  return slug;
}

function buildPickFromForm(slug){
  const sport   = $('#sport')?.value || 'soccer_epl'; // ha külön form nincs, nem baj
  const eventId = $('#eventId').value.trim() || 'match';
  const eventName = $('#eventName').value.trim() || $('#title').value.trim();
  const kick    = toISOZ($('#kick').value);
  const market  = $('#market').value;
  const selection = $('#sel').value.trim();
  const line    = $('#line').value ? Number($('#line').value) : 0.0;
  const odds    = $('#odds').value ? Number($('#odds').value) : 1.0;
  const stake   = $('#stake').value ? Number($('#stake').value) : 0;
  const status  = $('#status').value;

  if(!selection) throw new Error('Hiányzik a tipp „Választás” mező.');

  return {
    id: `${eventId}-${Date.now()}`,
    sport, league: ($('#league').value||'').trim(),
    eventId, eventName,
    market, selection, line,
    odds: Number(odds.toFixed(2)),
    stake: Number(stake),
    commence_time: kick || new Date().toISOString(),
    status,
    result: "",
    profit: 0,
    postSlug: slug
  };
}

async function savePick(pick){
  let arr=[];
  try{ const {text}=await ghGet('data/picks.json'); arr=JSON.parse(text) }catch(_){ arr=[] }
  arr = Array.isArray(arr)?arr:[];
  // ha ugyanaz a postSlug + eventId már megvan, cseréljük
  arr = arr.filter(p => !(p.postSlug===pick.postSlug && p.eventId===pick.eventId));
  arr.unshift(pick);
  await ghPut('data/picks.json', JSON.stringify(arr,null,2), 'Add pick');
}

/*** ------- GOMBOK ------- ***/
$('#publishOnly').onclick = async ()=>{
  try{
    msg('#msg','Mentés…');
    const slug = await savePost();
    msg('#msg','Cikk elkészült: posts/'+slug+'.html',true);
  }catch(e){ msg('#msg',e.message,false); }
};

$('#tipOnly').onclick = async ()=>{
  try{
    msg('#msg','Tipp mentése…');
    const slug = $('#slug').value.trim() || makeSlug($('#title').value,$('#postDate').value);
    const pick = buildPickFromForm(slug);
    await savePick(pick);
    msg('#msg','Tipp elmentve a statisztikához.',true);
  }catch(e){ msg('#msg',e.message,false); }
};

$('#publishAll').onclick = async ()=>{
  try{
    msg('#msg','Közzététel…');
    const slug = await savePost();              // cikk + index frissítés
    const pick = buildPickFromForm(slug);       // tipp a formból
    await savePick(pick);                       // picks.json frissítés
    msg('#msg','Cikk és tipp elmentve. A főoldalon megjelenik, a Statisztikában pedig a tipp látszik.',true);
  }catch(e){ msg('#msg',e.message,false); }
};
</script>
</body>
</html>
