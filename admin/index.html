<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – SportElemzés</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <style>
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:#111;border:1px solid #333;border-radius:10px;padding:16px;margin:14px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{display:block;font-weight:600;margin:8px 0 6px}
    input,select,textarea{width:100%;background:#0c0c0c;border:1px solid #2d2d2d;color:#e6e6e6;border-radius:8px;padding:10px}
    textarea{min-height:140px}
    .editor{min-height:220px;border:1px solid #2d2d2d;border-radius:8px;background:#0c0c0c;color:#e6e6e6;padding:10px;outline:none}
    .muted{opacity:.75}
    .btn{background:#1f6feb;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:#202020;color:#e6e6e6;border:1px solid #2d2d2d}
    .ok{color:#6ee7a8}
    .err{color:#fca5a5}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .help{font-size:.92em;opacity:.85}
  </style>
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemzés</span></a>
    <div class="links">
      <a href="/">Elemzések</a>
      <a href="/stats.html">Statisztika</a>
      <a class="active" href="/admin/">Admin</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>Admin</h1>
    <p>Gyors közzététel GitHub API-val (nincs szerver)</p>
  </div>
</header>

<main class="container">
  <!-- TOKEN -->
  <section class="card">
    <h2>Token</h2>
    <p class="help">Fine-grained token: csak ehhez a repóhoz, <em>Repository contents: Read/Write</em>.</p>
    <div class="row">
      <div>
        <label>Token</label>
        <input id="gh_token" type="password" placeholder="ghp_xxx…" />
      </div>
      <div style="align-self:end">
        <button id="saveTok" class="btn">Token mentése</button>
        <span id="tokmsg" class="muted"></span>
      </div>
    </div>
  </section>

  <!-- ÚJ CIKK -->
  <section class="card">
    <h2>Új cikk</h2>
    <p class="help">A szövegmező NEM textarea (contenteditable), így nem ronthatja szét a lapot.</p>

    <div class="row">
      <div>
        <label>Cím</label>
        <input id="title" placeholder="Pl. Newcastle vs Liverpool – elemzés és tipp" />
      </div>
      <div>
        <label>Kezdés (helyi idő - CET / CEST)</label>
        <input id="date" type="datetime-local" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Liga / sport</label>
        <input id="league" placeholder="EPL / Foci" />
      </div>
      <div>
        <label>Slug (ha üres, a cím + dátum alapján készül)</label>
        <input id="slug" placeholder="2025-08-25-newcastle-liverpool" />
      </div>
    </div>

    <div>
      <label>Rövid kivonat (excerpt)</label>
      <textarea id="excerpt" placeholder="1–2 mondatban a lényeg"></textarea>
    </div>

    <div>
      <label>Cikk szövege (HTML is lehet)</label>
      <div id="body" class="editor" contenteditable="true" spellcheck="true" placeholder="Ide írd a cikket…"></div>
    </div>
  </section>

  <!-- TIPPMEZŐ -->
  <section class="card">
    <h2>Új tipp a statisztikába</h2>
    <div class="row-3">
      <div>
        <label>Sport kulcs</label>
        <input id="p_sport" value="soccer_epl" />
      </div>
      <div>
        <label>Meccs / Event ID (egyedi azonosító)</label>
        <input id="p_event" placeholder="NEW-LIV vagy teljes név" />
      </div>
      <div>
        <label>Kezdés (helyi idő)</label>
        <input id="p_dt" type="datetime-local" />
      </div>
    </div>

    <div class="row-3">
      <div>
        <label>Piac</label>
        <select id="p_market">
          <option value="h2h">h2h (1X2)</option>
          <option value="totals">totals (o/u)</option>
          <option value="asian_handicap" selected>asian_handicap (AH)</option>
        </select>
      </div>
      <div>
        <label>Választás</label>
        <select id="p_sel">
          <option value="home">home</option>
          <option value="away">away</option>
          <option value="draw">draw</option>
          <option value="over">over</option>
          <option value="under">under</option>
        </select>
      </div>
      <div>
        <label>Vonal (opcionális)</label>
        <input id="p_line" placeholder="pl. 0.0 vagy 2.5" />
      </div>
    </div>

    <div class="row-3">
      <div>
        <label>Odds</label>
        <input id="p_odds" placeholder="pl. 1.90" />
      </div>
      <div>
        <label>Tét</label>
        <input id="p_stake" value="1000" />
      </div>
      <div>
        <label>Státusz</label>
        <select id="p_status">
          <option value="open" selected>open</option>
          <option value="won">won</option>
          <option value="lost">lost</option>
          <option value="void">void</option>
        </select>
      </div>
    </div>
    <div class="bar">
      <button id="pubBoth" class="btn">Cikk közzététele + Tipp mentése</button>
      <button id="pubPost" class="btn-ghost">Csak cikk közzététele</button>
      <button id="pubPick" class="btn-ghost">Csak tipp mentése</button>
      <span id="msg" class="muted"></span>
    </div>
    <p class="help muted">Repó: <code>sportelemzes/sportelemzes.github.io</code>. Fájlok: <code>posts/*.html</code>, <code>posts/index.json</code>, <code>data/picks.json</code>.</p>
  </section>
</main>

<script>
/* ====== Beállítások ====== */
const OWNER  = "sportelemzes";
const REPO   = "sportelemzes.github.io";
const BRANCH = "main";

/* ====== Kisegítő függvények ====== */
const $ = s => document.querySelector(s);

function slugify(str){
  return str
    .toLowerCase().trim()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"");
}

function toISO(localDateTime){
  // a datetime-local mező értéke helyi idő (CET/CEST); ISO-ra alakítjuk
  const d = new Date(localDateTime);
  return d.toISOString(); // UTC-re forgatva kerül a JSON-ba
}

function htmlEscape(s){
  return s.replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/* ====== Token mentés ====== */
$("#gh_token").value = localStorage.getItem("gh_token") || "";
$("#saveTok").onclick = () => {
  const t = $("#gh_token").value.trim();
  if(!t){ $("#tokmsg").textContent = "Üres token."; $("#tokmsg").className="err"; return; }
  localStorage.setItem("gh_token", t);
  $("#tokmsg").textContent = "Token elmentve."; $("#tokmsg").className="ok";
};

/* ====== GitHub API wrap ====== */
async function ghGet(path){
  const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`, {
    headers:{ Authorization: `token ${localStorage.getItem("gh_token")}` }
  });
  if(!r.ok) throw new Error(`GET ${path}: ${r.status} ${r.statusText}`);
  return r.json();
}

async function ghPut(path, content, message, sha=null){
  const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      Authorization:`token ${localStorage.getItem("gh_token")}`
    },
    body: JSON.stringify({
      message, branch: BRANCH,
      content: btoa(unescape(encodeURIComponent(content))),
      sha
    })
  });
  if(!r.ok){ const t=await r.text(); throw new Error(`PUT ${path}: ${r.status} ${t}`); }
  return r.json();
}

async function getFile(path){
  try{
    const j = await ghGet(path);
    return { sha: j.sha, text: decodeURIComponent(escape(atob(j.content))) };
  }catch(e){ return { sha:null, text:null }; }
}

/* ====== Poszt HTML sablon ====== */
function renderPostHTML({title, dateISO, league, excerpt, bodyHtml}){
  // itt a bodyHtml a contenteditable .innerHTML-je
  return `<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>${title}</title>
  <link rel="stylesheet" href="/assets/style.css"/>
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemzés</span></a>
    <div class="links">
      <a href="/">Elemzések</a>
      <a href="/stats.html">Statisztika</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>${title}</h1>
    <p class="muted">${league} • ${new Date(dateISO).toLocaleString("hu-HU",{year:"numeric",month:"2-digit",day:"2-digit"})}</p>
  </div>
</header>
<main class="container">
  <article class="card">
    <h2>Összefoglaló</h2>
    <p>${htmlEscape(excerpt).replace(/\n/g,"<br>")}</p>
    <hr class="muted" style="margin:18px 0;border-color:#2a2a2a"/>
    <div>${bodyHtml}</div>
  </article>
</main>
<footer class="muted" style="text-align:center;padding:24px 0">
  <div class="links">
    <a href="/">Elemzések</a>
    <a href="/stats.html">Statisztika</a>
    <a href="/privacy.html">Adatkezelés</a>
  </div>
  <div>© <span id="y">${new Date().getFullYear()}</span> SportElemzés • GitHub Pages</div>
</footer>
</body>
</html>`;
}

/* ====== Közzététel ====== */
async function publishPost(){
  const title   = $("#title").value.trim();
  const league  = $("#league").value.trim() || "EPL / Foci";
  const dtVal   = $("#date").value; // datetime-local
  const excerpt = $("#excerpt").value.trim();
  const bodyHtml= $("#body").innerHTML; // contenteditable

  if(!title) throw new Error("Hiányzik a cím.");
  if(!dtVal) throw new Error("Hiányzik a kezdési idő.");
  if(!excerpt) throw new Error("Hiányzik az összefoglaló.");
  if(!bodyHtml) throw new Error("Hiányzik a cikk szövege.");

  const dateISO = toISO(dtVal);
  const slug = ($("#slug").value.trim() || `${dtVal.slice(0,10)}-${slugify(title)}`).replace(/-+/g,"-");

  // poszt html írása
  const htmlPath = `posts/${slug}.html`;
  const htmlOld  = await getFile(htmlPath);
  const html     = renderPostHTML({title, dateISO, league, excerpt, bodyHtml});
  await ghPut(htmlPath, html, `Add post: ${title}`, htmlOld.sha);

  // posts/index.json frissítése (lista)
  const idxPath  = "posts/index.json";
  const idxOld   = await getFile(idxPath);
  let arr        = [];
  if(idxOld.text) try{ arr = JSON.parse(idxOld.text); }catch(_) {}
  // töröljük ha ugyanazzal a sluggal már lenne
  arr = arr.filter(x => x.slug !== slug);
  arr.unshift({ title, date: dateISO, league, slug });
  await ghPut(idxPath, JSON.stringify(arr,null,2), `Update posts index; add ${slug}`, idxOld.sha);

  return slug;
}

function makePickFromForm(slug){
  const sport   = $("#p_sport").value.trim() || "soccer_epl";
  const eventId = $("#p_event").value.trim() || "match";
  const commence_time = toISO($("#p_dt").value || new Date().toISOString());
  const market  = $("#p_market").value;
  const selection = $("#p_sel").value;
  const line    = $("#p_line").value ? Number($("#p_line").value) : 0.0;
  const odds    = Number($("#p_odds").value || "0");
  const stake   = Number($("#p_stake").value || "0");
  const status  = $("#p_status").value;

  return {
    id: `${eventId}-${Date.now()}`,
    sport, league: "Premier League",
    eventId, eventName: eventId,
    market, selection, line,
    odds, stake, commence_time,
    status, result: "", profit: "",
    postSlug: slug
  };
}

async function publishPickOnly(slugForRef=null){
  const p = makePickFromForm(slugForRef || "");
  const filePath = "data/picks.json";
  const old = await getFile(filePath);
  let arr = [];
  if(old.text) try{ arr = JSON.parse(old.text); }catch(_) {}
  // ha van azonos postSlug + eventId duplikált korábbi, töröljük
  arr = arr.filter(x => !(x.postSlug===p.postSlug && x.eventId===p.eventId));
  arr.unshift(p);
  await ghPut(filePath, JSON.stringify(arr,null,2), "Add pick", old.sha);
}

function msg(s, ok=false){ const el=$("#msg"); el.textContent=s; el.className = ok ? "ok" : "err"; }

/* ====== Gombok ====== */
$("#pubPost").onclick = async ()=>{
  try{ msg("Közzététel…"); const slug = await publishPost(); msg(`Cikk kész: posts/${slug}.html`, true); }
  catch(e){ msg(e.message||String(e)); }
};
$("#pubPick").onclick = async ()=>{
  try{ msg("Tipp mentése…"); await publishPickOnly(); msg(`Tipp elmentve.`, true); }
  catch(e){ msg(e.message||String(e)); }
};
$("#pubBoth").onclick = async ()=>{
  try{
    msg("Cikk + tipp közzététele…");
    const slug = await publishPost();
    await publishPickOnly(slug);
    msg("Kész: cikk + tipp elmentve.", true);
  }catch(e){ msg(e.message||String(e)); }
};
</script>
</body>
</html>
