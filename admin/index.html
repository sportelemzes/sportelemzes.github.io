<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – SportElemzés</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <style>
    .admin-card{background:#121212;border:1px solid #2a2a2a;border-radius:12px;padding:16px;margin:16px 0}
    .admin-card h3{margin:0 0 8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:13px;color:#bbb;margin:8px 0 4px}
    input,select,textarea{width:100%;background:#1a1a1a;border:1px solid #2c2c2c;border-radius:8px;color:#e6e6e6;padding:10px}
    textarea{min-height:120px}
    button.primary{background:#2563eb;border:0;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#333;border:1px solid #444;color:#ddd;border-radius:10px;padding:10px 14px;cursor:pointer}
    small.mono{font-family:ui-monospace,Consolas,monospace;color:#9aa}
    .muted{color:#9aa}
    .ok{color:#43d17c}
    .warn{color:#e0b44d}
    .err{color:#ff6b6b}
  </style>
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemzés</span></a>
    <div class="links">
      <a href="/">Elemzések</a>
      <a href="/stats.html">Statisztika</a>
      <a class="active" href="/admin/">Admin</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>Admin</h1>
    <p class="muted">Gyors közzététel GitHub API-val (nincs szerver)</p>
  </div>
</header>

<main class="main">
  <!-- TOKEN -->
  <section class="admin-card">
    <h3>Token <small class="muted">(egyszer add meg, a böngésződből megmarad)</small></h3>
    <p class="muted">Fine-grained token: csak ehhez a repóhoz, <em>Repository contents: Read/Write</em>.</p>
    <div class="row">
      <div>
        <label>Token</label>
        <input id="gh_token" placeholder="ghp_xxx…" />
      </div>
      <div style="align-self:end">
        <button class="primary" id="saveToken">Token mentése</button>
        <div class="muted" id="tokenMsg"></div>
      </div>
    </div>
  </section>

  <!-- ÚJ CIKK (röviden – nálad már működik; meghagyjuk az alapot) -->
  <section class="admin-card">
    <h3>Új cikk</h3>
    <p class="muted">A meglévő publikáló űrlapod itt marad – rövidre fogtam. Ha mást használsz, hagyd figyelmen kívül.</p>
    <div class="row">
      <div>
        <label>Cím</label>
        <input id="title" placeholder="Pl. Newcastle vs Liverpool – elemzés és tipp">
      </div>
      <div>
        <label>Dátum</label>
        <input id="date" type="datetime-local">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Rövid kivonat (excerpt)</label>
        <input id="excerpt" placeholder="1–2 mondatban a lényeg">
      </div>
      <div>
        <label>Liga / sport (opcionális)</label>
        <input id="league" placeholder="EPL / Foci">
      </div>
    </div>
    <label>Cikk szövege</label>
    <textarea id="body" placeholder="Írd ide a cikket…"></textarea>
    <div style="margin-top:10px">
      <button class="secondary" id="publish">Cikk közzététele</button>
      <span id="msg" class="muted"></span>
    </div>
  </section>

  <!-- ÚJ TIPP / STAT – ez a már meglévő űrlapod mintája -->
  <section class="admin-card">
    <h3>Új tipp a statisztikába</h3>
    <div class="row">
      <div>
        <label>Sport kulcs</label>
        <input id="p_sport" value="soccer_epl" />
      </div>
      <div>
        <label>Meccs / Event (emberi azonosító)</label>
        <input id="p_event" placeholder="NEW-LIV vagy teljes név" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Kickoff (helyi idő)</label>
        <input id="p_dt" type="datetime-local" />
      </div>
      <div>
        <label>Piac</label>
        <select id="p_market">
          <option value="h2h">h2h (1x2)</option>
          <option value="asian_handicap">asian_handicap</option>
          <option value="totals">totals (o/u)</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Vonal (opcionális)</label>
        <input id="p_line" placeholder="0.0 vagy 2.5" />
      </div>
      <div>
        <label>Választás</label>
        <select id="p_sel">
          <option value="home">home</option>
          <option value="away">away</option>
          <option value="draw">draw</option>
          <option value="over">over</option>
          <option value="under">under</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Odds</label>
        <input id="p_odds" placeholder="pl. 1.90" />
      </div>
      <div>
        <label>Tét</label>
        <input id="p_stake" placeholder="1000" value="1000" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Státusz</label>
        <select id="p_status">
          <option value="open" selected>open</option>
          <option value="won">won</option>
          <option value="lost">lost</option>
          <option value="void">void</option>
        </select>
      </div>
      <div style="align-self:end">
        <button class="secondary" id="savePick">Tipp mentése</button>
        <span id="msgPick" class="muted"></span>
      </div>
    </div>
  </section>

  <!-- ODDS FRISSÍTÉS – WORKFLOW INDÍTÁSA -->
  <section class="admin-card">
    <h3>Odds frissítés (GitHub Actions)</h3>
    <p class="muted">Szerveroldalon frissíti az <code>data/picks.json</code>-ban az oddsokat az <em>open</em> státuszú tippeknél.</p>
    <div>
      <button class="primary" id="runOdds">Odds frissítés indítása</button>
      <span id="oddsMsg" class="muted"></span>
      <p class="muted"><small class="mono">.github/workflows/update-odds.yml</small> fut, az API-kulcs <em>ODDS_API_KEY</em> a repó Secrets-ben van.</p>
    </div>
  </section>
</main>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const msg = $('#msg');
  const msgPick = $('#msgPick');
  const oddsMsg = $('#oddsMsg');

  // --- token load/save
  $('#gh_token').value = localStorage.getItem('gh_token') || '';
  $('#saveToken').onclick = () => {
    const t = $('#gh_token').value.trim();
    if (!t.startsWith('gh')) { $('#tokenMsg').textContent = '⚠️ Furcsa tokennek tűnik.'; }
    localStorage.setItem('gh_token', t);
    $('#tokenMsg').innerHTML = '<span class="ok">Token elmentve.</span>';
  };

  // --- minimal post publish (nálad már külön van – ez csak minta)
  $('#publish').onclick = async () => {
    try {
      const token = localStorage.getItem('gh_token');
      if (!token) { alert('Adj meg GitHub tokent!'); return; }

      const title = $('#title').value.trim();
      const date  = $('#date').value;
      const league = $('#league').value.trim();
      const body  = $('#body').value;

      if (!title || !date || !body) { alert('Cím, dátum, szöveg kötelező.'); return; }

      // nagyon egyszerű "post" – hoz létre egy HTML fájlt a /posts alatt
      const slug = date.slice(0,10) + '-' + title.toLowerCase()
        .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      const html = `
<!doctype html><html lang="hu"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${title}</title><link rel="stylesheet" href="/assets/style.css"></head>
<body>
<header class="header-hero"><nav class="hero-nav"><a class="brand" href="/"><span>SportElemzés</span></a>
<div class="links"><a href="/">Elemzések</a><a href="/stats.html">Statisztika</a></div></nav>
<div class="hero-inner"><h1>${title}</h1><p class="muted">${league ? league+' • ': ''}${date.slice(0,10)}</p></div></header>
<main class="main post">
${body}
</main>
<footer class="muted" style="text-align:center;padding:24px 0">
 <div class="links">
   <a href="/">Elemzések</a>
   <a href="/stats.html">Statisztika</a>
   <a href="/privacy.html">Adatkezelés</a>
 </div>
</footer>
<script src="/assets/site.js" defer></script>
</body></html>`;

      await ghPut(`posts/${slug}.html`, html, `Add post: ${title}`);
      msg.innerHTML = '<span class="ok">Kész! A főoldalon megjelent.</span>';
    } catch (e) {
      msg.innerHTML = '<span class="err">Hiba: ' + e.message + '</span>';
    }
  };

  // --- Tippek mentése
  $('#savePick').onclick = async () => {
    try {
      const file = 'data/picks.json';
      const arr = await ghGet(file);

      const event = $('#p_event').value.trim();
      if (!event) { alert('Event azonosító kell (pl. NEW-LIV).'); return; }

      const pick = {
        id: 'pick-'+Math.random().toString(36).slice(2,9),
        sport: $('#p_sport').value.trim() || 'soccer_epl',
        eventId: event,
        kickoff: $('#p_dt').value ? new Date($('#p_dt').value).toISOString() : null,
        market: $('#p_market').value,
        line: $('#p_line').value ? Number($('#p_line').value) : null,
        selection: $('#p_sel').value,
        odds: $('#p_odds').value ? Number($('#p_odds').value) : null,
        stake: $('#p_stake').value ? Number($('#p_stake').value) : 0,
        status: $('#p_status').value,
        result: null,
        profit: null
      };

      arr.unshift(pick);
      await ghPut(file, JSON.stringify(arr, null, 2)+'\n', 'Add pick '+pick.id);
      msgPick.innerHTML = '<span class="ok">Tipp elmentve.</span>';
    } catch (e) {
      msgPick.innerHTML = '<span class="err">Hiba: '+e.message+'</span>';
    }
  };

  // --- Odds workflow indítása
  $('#runOdds').onclick = async () => {
    try {
      const token = localStorage.getItem('gh_token');
      if (!token) { alert('Adj meg GitHub tokent!'); return; }

      const owner = 'sportelemzes';        // ← a tied!
      const repo  = 'sportelemzes.github.io'; // ← a tied!
      const wf    = 'update-odds.yml';

      const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/${wf}/dispatches`, {
        method: 'POST',
        headers: { 'Authorization': `token ${token}`, 'Accept':'application/vnd.github+json' },
        body: JSON.stringify({ ref: 'main' })
      });
      if (!r.ok) throw new Error(await r.text());
      oddsMsg.innerHTML = '<span class="ok">Elindítva. 30–90 mp és frissül.</span>';
    } catch (e) {
      oddsMsg.innerHTML = '<span class="err">Hiba: '+e.message+'</span>';
    }
  };

  // --- GitHub API helper
  async function ghGet(path) {
    const token = localStorage.getItem('gh_token');
    if (!token) throw new Error('Nincs token.');
    const owner = 'sportelemzes';
    const repo  = 'sportelemzes.github.io';

    const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=main`, {
      headers: { 'Authorization': 'token '+token, 'Accept':'application/vnd.github+json' }
    });
    if (!r.ok) throw new Error('GET '+path+': '+r.status);
    const j = await r.json();
    if (!j.content) return []; // új fájl eset
    const b64 = atob(j.content);
    return JSON.parse(b64);
  }

  async function ghPut(filePath, content, message) {
    const token = localStorage.getItem('gh_token');
    const owner = 'sportelemzes';
    const repo  = 'sportelemzes.github.io';

    // get old sha if exists
    let sha=null; {
      const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}?ref=main`, {
        headers: { 'Authorization': 'token '+token, 'Accept':'application/vnd.github+json' }
      });
      if (r.ok) { const j = await r.json(); sha = j.sha; }
    }

    const r2 = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
      method: 'PUT',
      headers: { 'Authorization': 'token '+token, 'Accept':'application/vnd.github+json', 'Content-Type':'application/json' },
      body: JSON.stringify({ message, content: btoa(content), branch: 'main', sha })
    });
    if (!r2.ok) throw new Error('PUT '+filePath+': '+(await r2.text()));
    return true;
  }
})();
</script>
</body>
</html>
