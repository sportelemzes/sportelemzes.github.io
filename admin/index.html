<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – SportElemzés</title>
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    main { max-width: 1050px; margin: 0 auto; padding: clamp(16px, 3vw, 28px); }
    .admin-box { background:#121212; border:1px solid #2a2a2a; border-radius:12px; padding:16px; margin:16px 0; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .muted { color:#8aa; font-size:13px; }
    input, textarea, select, button { width:100%; padding:10px 12px; background:#0f0f0f; color:#e6e6e6; border:1px solid #2b2b2b; border-radius:8px; }
    label { font-weight:600; margin-top:10px; display:block; }
    button { background:#1855d1; border:0; cursor:pointer; }
    button:hover { filter:brightness(1.1) }
    small.hint { color:#9ab; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .wide { grid-column: 1 / -1; }
    #msg, #msgPick { margin-top:8px; font-size:13px; color:#8db; min-height:1em; }
  </style>
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemzés</span></a>
    <div class="links">
      <a href="/">Elemzések</a>
      <a href="/stats.html">Statisztika</a>
      <a class="active" href="/admin/">Admin</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>Admin</h1>
    <p>Gyors közzététel GitHub API-val (nincs szerver)</p>
  </div>
</header>

<main>

  <!-- TOKEN -->
  <section class="admin-box">
    <p><b>Token</b> <span class="muted">(egyszer add meg, a böngésződbben marad)</span></p>
    <p class="muted">Fine-grained token: csak ehhez a repóhoz, <i>Repository contents: Read/Write</i>.</p>
    <div class="row">
      <input id="gh_token" placeholder="ghp_xxx…" />
      <button id="saveToken">Token mentése</button>
    </div>
    <div id="tokenInfo" class="muted" style="margin-top:6px;">Nincs token elmentve.</div>
  </section>

  <!-- ÚJ CIKK -->
  <section class="admin-box">
    <h3>Új cikk</h3>

    <label for="p_title">Cím</label>
    <input id="p_title" placeholder="Pl. Newcastle vs Liverpool – elemzés és tipp">

    <div class="row">
      <div>
        <label for="p_date">Dátum</label>
        <input id="p_date" type="date">
      </div>
      <div>
        <label for="p_time">Kezdés (helyi idő)</label>
        <input id="p_time" type="time" placeholder="20:45">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="p_excerpt">Rövid kivonat (excerpt)</label>
        <input id="p_excerpt" placeholder="1–2 mondatban a lényeg">
      </div>
      <div>
        <label for="p_league">Liga / sport (opcionális)</label>
        <input id="p_league" placeholder="EPL / Foci">
      </div>
    </div>

    <label for="p_body">Cikk szövege (HTML vagy sima szöveg)</label>
    <textarea id="p_body" rows="12" placeholder="Írd ide a cikket…"></textarea>

    <label for="p_slug">Slug (ha üres, a cím + dátum alapján készül)</label>
    <input id="p_slug" placeholder="2025-08-25-newcastle-liverpool">

    <div class="row" style="margin-top:10px">
      <button id="publish">Cikk közzététele</button>
    </div>
    <div id="msg"></div>
  </section>

  <!-- ÚJ TIPP a statisztikába -->
  <section class="admin-box">
    <h3>Új tipp a statisztikába</h3>

    <div class="row">
      <div>
        <label for="p_sport">Sport kulcs</label>
        <input id="p_sport" value="soccer_epl" />
      </div>
      <div>
        <label for="p_event">Meccs / Event ID</label>
        <input id="p_event" placeholder="pl. ARS-CHE vagy valamilyen azonosító">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="p_kickoff">Kezdés (helyi idő)</label>
        <input id="p_kickoff" type="datetime-local" />
      </div>
      <div>
        <label for="p_market">Választás</label>
        <select id="p_market">
          <option value="h2h">h2h (1X2)</option>
          <option value="totals">totals (gólok)</option>
          <option value="asian_handicap">asian handicap</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="p_sel">Vonal (opcionális)</label>
        <input id="p_line" placeholder="pl. 2.5">
      </div>
      <div>
        <label for="p_sel">Választás</label>
        <select id="p_sel">
          <option value="home">home</option>
          <option value="draw">draw</option>
          <option value="away">away</option>
          <option value="over">over</option>
          <option value="under">under</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="p_odds">Odds</label>
        <input id="p_odds" placeholder="pl. 1.90">
      </div>
      <div>
        <label for="p_stake">Tét</label>
        <input id="p_stake" placeholder="1000">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="p_status">Státusz</label>
        <select id="p_status">
          <option value="open">open</option>
          <option value="won">won</option>
          <option value="lost">lost</option>
          <option value="void">void</option>
        </select>
      </div>
      <div class="wide" style="text-align:right">
        <button id="savePick" style="width:auto">Tipp mentése</button>
      </div>
    </div>

    <div id="msgPick"></div>
  </section>

</main>

<script>
const OWNER = 'sportelemzes';
const REPO  = 'sport-elemzes.github.io';
const BRANCH= 'main';
const HEADS = { 'Accept':'application/vnd.github+json' };

// --- utils ---
const b64 = s=> btoa(unescape(encodeURIComponent(s)));
const ub64= s=> decodeURIComponent(escape(atob(s)));
const $   = sel => document.querySelector(sel);
const fmtDate = d => {
  // YYYY-MM-DD -> 2025. 08. 25.
  const [y,m,dd] = d.split('-');
  return `${y}. ${m}. ${dd}.`;
};

// token
const tEl = $('#gh_token');
const tInfo= $('#tokenInfo');
(() => {
  const t = localStorage.getItem('gh_token');
  if (t) { tEl.value = t; tInfo.textContent = 'Token elmentve.'; }
})();
$('#saveToken').onclick = () => {
  localStorage.setItem('gh_token', tEl.value.trim());
  tInfo.textContent = 'Token elmentve.';
};

// GitHub API
async function ghGet(path){
  const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`, { headers: HEADS });
  if(!r.ok) throw new Error('GET ' + path);
  return r.json();
}
async function ghPut(path, content, message, sha){
  const token = localStorage.getItem('gh_token');
  if(!token) throw new Error('Adj meg tokent!');
  const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
    method:'PUT',
    headers: { ...HEADS, 'Authorization': `token ${token}`, 'Content-Type':'application/json'},
    body: JSON.stringify({ message, content: b64(content), branch: BRANCH, sha })
  });
  if(!r.ok) throw new Error('PUT ' + path + ' • ' + r.status);
  return r.json();
}

// --- cikk közzététel ---
function makeSlug(title, date){
  const s = (title || '').toLowerCase()
      .replace(/[^\p{L}\p{N}]+/gu, '-')
      .replace(/^-+|-+$/g,'');
  return `${date}-${s}`.replace(/-+/g,'-');
}

function renderPostHTML({title, league, date, time, body}){
  const dateTxt = fmtDate(date);
  const timeHtml = time ? ` • <time datetime="${date}T${time}">${time}</time>` : '';
return `<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${title}</title>
<link rel="stylesheet" href="/assets/style.css">
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemzés</span></a>
    <div class="links">
      <a class="active" href="/">Elemzések</a>
      <a href="/stats.html">Statisztika</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>${title}</h1>
    <p>${league ? league + ' • ' : ''}${dateTxt}${timeHtml}</p>
  </div>
</header>

<main>
  <article class="card">
    ${body}
  </article>
</main>

<footer class="muted" style="text-align:center;padding:24px 0">
  © ${new Date().getFullYear()} SportElemzés
</footer>
</body>
</html>`;
}

$('#publish').onclick = async () => {
  const title   = $('#p_title').value.trim();
  const date    = $('#p_date').value.trim();
  const time    = $('#p_time').value.trim(); // HH:MM – opcionális
  const league  = $('#p_league').value.trim();
  const excerpt = $('#p_excerpt').value.trim();
  const body    = $('#p_body').value.trim();
  let   slug    = $('#p_slug').value.trim();

  const msg = $('#msg'); msg.textContent = '';

  if(!title || !date || !body){ msg.textContent = 'Cím és cikk kötelező.'; return; }
  if(!slug) slug = makeSlug(title, date);

  // poszt HTML
  const html = renderPostHTML({ title, league, date, time, body });

  try {
    // poszt fájl
    await ghPut(`posts/${slug}.html`, html, `Add post: ${title}`);

    // index.json frissítés
    const idx = await ghGet('posts/index.json');
    const arr = JSON.parse(ub64(idx.content));
    arr.unshift({ title, slug, date, time: time || null, league, excerpt });
    await ghPut('posts/index.json', JSON.stringify(arr, null, 2), 'Update posts index', idx.sha);

    msg.textContent = 'Kész! Megnyitás után pár mp és látszik a főoldalon is.';
    $('#p_slug').value = slug;
  } catch(e) {
    console.error(e);
    msg.textContent = 'Hiba: ' + (e.message || e);
  }
};

// --- TIPPEK (változatlan logika) ---
function toISOZ(local){
  const d = new Date(local);
  if(isNaN(d.getTime())) return new Date().toISOString();
  return d.toISOString();
}
function makePickId(eventId){
  return `${eventId}`.toLowerCase().replace(/[^\w\-]+/g,'').slice(0,12);
}

$('#savePick').onclick = async () => {
  const token = localStorage.getItem('gh_token'); if(!token){ alert('Adj meg tokent!'); return; }

  const sport   = $('#p_sport').value.trim() || 'soccer_epl';
  const eventId = $('#p_event').value.trim();
  const kickoff = $('#p_kickoff').value;
  const market  = $('#p_market').value;
  const selection = $('#p_sel').value;
  const line    = $('#p_line').value.trim();
  const odds    = parseFloat($('#p_odds').value||'0');
  const stake   = parseFloat($('#p_stake').value||'0');
  const status  = $('#p_status').value;

  const msg = $('#msgPick'); msg.textContent = '';

  if(!eventId || !odds || !stake){ alert('Választás, odds és tét kötelező!'); return; }

  const pick = {
    id: makePickId(eventId),
    sport_key: sport,
    eventId: eventId,
    market, selection,
    line: line ? parseFloat(line) : null,
    odds, stake,
    commence_time: toISOZ(kickoff),
    status
  };

  try {
    const file = await ghGet('data/picks.json').catch(_=>null);
    let arr = []; let sha=null;
    if(file){ arr = JSON.parse(ub64(file.content)); sha = file.sha; }
    arr.unshift(pick);
    await ghPut('data/picks.json', JSON.stringify(arr, null, 2), 'Add pick', sha);
    msg.textContent = 'Tipp elmentve.';
  } catch(e){
    msg.textContent = 'Hiba: '+(e.message||e);
  }
};
</script>
</body>
</html>
