<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SportElemz√©s ‚Äì Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="/assets/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîí</text></svg>">
</head>
<body>

<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemz√©s</span></a>
    <div class="links">
      <a href="/">Elemz√©sek</a>
      <a href="/stats.html">Statisztika</a>
      <a href="/admin/" rel="nofollow">Admin</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>Admin</h1>
    <p>Gyors k√∂zz√©t√©tel GitHub API-val (nincs szerver)</p>
  </div>
</header>

<main>

  <!-- TOKEN doboz -->
  <section class="card admin-only">
    <h3>Token <small>(egyszer add meg, a b√∂ng√©sz≈ëdben marad)</small></h3>
    <p class="muted">Fine-grained token: csak ehhez a rephoz, <em>Repository contents: Read/Write</em>.</p>
    <div class="controls">
      <input id="gh_token" type="password" placeholder="ghp_xxx‚Ä¶" style="max-width:320px">
      <button id="saveToken">Token ment√©se</button>
    </div>
    <p id="tokMsg" class="muted">Nincs token elmentve.</p>
  </section>

  <!-- √öJ CIKK -->
  <section class="card admin-only">
    <h3>√öj cikk</h3>

    <div class="controls">
      <label>C√≠m</label>
      <input id="title" placeholder="Pl. Newcastle vs Liverpool ‚Äì elemz√©s √©s tipp">
      <label>D√°tum</label>
      <input id="date" type="datetime-local">
    </div>

    <div class="controls">
      <label>R√∂vid kivonat (excerpt)</label>
      <input id="excerpt" placeholder="1‚Äì2 mondatban a l√©nyeg">
      <label>Liga / sport (opcion√°lis)</label>
      <input id="league" placeholder="EPL / Foci">
    </div>

    <div class="controls">
      <label>Cikk sz√∂vege (HTML vagy sima sz√∂veg)</label>
      <textarea id="body" rows="12" placeholder="√çrd ide a cikket‚Ä¶"></textarea>
    </div>

    <div class="controls">
      <label>Slug (ha √ºres, a c√≠m + d√°tum alapj√°n k√©sz√ºl)</label>
      <input id="slug" placeholder="2025-08-25-newcastle-liverpool">
    </div>

    <div class="controls">
      <button id="publish">Cikk k√∂zz√©t√©tele</button>
      <span id="msg" class="muted"></span>
    </div>
  </section>

  <!-- √öJ TIPP -->
  <section class="card admin-only">
    <h3>√öj tipp a statisztik√°ba</h3>

    <div class="grid-3">
      <div>
        <label>Sport kulcs</label>
        <input id="p_sport" value="soccer_epl">
      </div>
      <div>
        <label>Meccs / Event ID</label>
        <input id="p_event" placeholder="PL_ARS-CHE vagy valamilyen azonos√≠t√≥">
      </div>
      <div>
        <label>Kezd√©s (helyi id≈ë)</label>
        <input id="p_dt" type="datetime-local">
      </div>
    </div>

    <div class="grid-4">
      <div>
        <label>Piac</label>
        <select id="p_market">
          <option value="h2h">h2h (1X2)</option>
          <option value="totals">totals</option>
          <option value="asian_handicap">asian_handicap</option>
        </select>
      </div>
      <div>
        <label>V√°laszt√°s</label>
        <select id="p_sel">
          <option value="home">home / draw / away ‚Ä¢ over / under</option>
          <option value="draw">draw</option>
          <option value="away">away</option>
          <option value="over">over</option>
          <option value="under">under</option>
        </select>
      </div>
      <div>
        <label>Vonal (opcion√°lis)</label>
        <input id="p_line" placeholder="pl. 2.5">
      </div>
      <div>
        <label>Odds</label>
        <input id="p_odds" placeholder="pl. 1.90">
      </div>
    </div>

    <div class="grid-3">
      <div>
        <label>T√©t</label>
        <input id="p_stake" value="1000">
      </div>
      <div>
        <label>St√°tusz</label>
        <select id="p_status">
          <option value="open">open</option>
          <option value="win">win</option>
          <option value="loss">loss</option>
        </select>
      </div>
      <div class="controls">
        <button id="savePick">Tipp ment√©se</button>
        <span id="msgPick" class="muted"></span>
      </div>
    </div>
  </section>

</main>

<footer>
  <small>¬© 2025 <strong>SportElemz√©s</strong> ‚Ä¢ <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a></small>
</footer>

<script>
// ------ soft guard: token nelk√ºl elrejtj√ºk az admin-only blokkokat ------
(function () {
  var token = localStorage.getItem('gh_token');
  if (!token) {
    document.querySelectorAll('.admin-only').forEach(function (el) {
      el.style.display = 'none';
    });
    var box = document.createElement('div');
    box.className = 'card';
    box.innerHTML = '<p>Ez az admin fel√ºlet csak a tulajdonos sz√°m√°ra √©rhet≈ë el. ' +
                    'Add meg a fine-grained token-t a b√∂ng√©sz≈ëdben a k√∂zz√©t√©telhez.</p>';
    document.querySelector('main').prepend(box);
  }
})();

// ------ GITHUB API KONFIG ------
const OWNER  = 'sportelemzes';
const REPO   = 'sportelemzes.github.io';
const BRANCH = 'main';

// ------ Seg√©dek ------
const b64e = (s) => btoa(unescape(encodeURIComponent(s)));
const b64d = (s) => decodeURIComponent(escape(atob(s)));
const $    = (sel) => document.querySelector(sel);

// ------ Token ment√©se ------
(function tokenInit(){
  const inp = $('#gh_token');
  const msg = $('#tokMsg');
  const saved = localStorage.getItem('gh_token');
  if (saved) msg.textContent = 'Token elmentve a b√∂ng√©sz≈ëben.';
  $('#saveToken').onclick = () => {
    const t = inp.value.trim();
    if (!t) { alert('Adj meg egy token-t.'); return; }
    localStorage.setItem('gh_token', t);
    msg.textContent = 'Token elmentve.';
    alert('Token mentve.');
  };
})();

// ------ GitHub API wrapper ------
async function ghGet(path){
  const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`, {
    headers: { 'Accept':'application/vnd.github+json' }
  });
  if (r.status === 404) return { sha:null, content:'' };
  if (!r.ok) throw new Error('GET '+path+' -> '+r.status);
  const j = await r.json();
  const text = j.content ? b64d(j.content) : '';
  return { sha: j.sha, content: text };
}

async function ghPut(path, content, message, sha){
  const token = localStorage.getItem('gh_token');
  if (!token) { alert('Adj meg token-t fent.'); throw new Error('No token'); }
  const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
    method:'PUT',
    headers:{
      'Accept':'application/vnd.github+json',
      'Authorization':'token ' + token,
      'Content-Type':'application/json'
    },
    body: JSON.stringify({
      message, content: b64e(content), branch: BRANCH, sha
    })
  });
  if (!r.ok) {
    const t = await r.text();
    throw new Error('PUT '+path+' -> '+r.status+' '+t);
  }
  return r.json();
}

// ------ Slug gy√°rt√°s ------
function makeSlug(title, dateISO){
  const base = (title||'').toLowerCase()
    .replace(/[√°√†√§]/g,'a').replace(/[√©√´√®]/g,'e')
    .replace(/[√≠√¨√Ø]/g,'i').replace(/[√≥√∂≈ë√≤]/g,'o')
    .replace(/[√∫√º≈±√π]/g,'u')
    .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  const d = (dateISO||'').slice(0,10);
  return `${d}-${base}`.replace(/-+/g,'-');
}

// ------ CIKK PUBLISH ------
$('#publish').onclick = async () => {
  const title   = $('#title').value.trim();
  const dateVal = $('#date').value;
  const excerpt = $('#excerpt').value.trim();
  const league  = $('#league').value.trim();
  const body    = $('#body').value.trim();
  const slugInp = $('#slug').value.trim();

  if (!title || !dateVal) { alert('C√≠m √©s d√°tum k√∂telez≈ë.'); return; }
  const dateISO = new Date(dateVal).toISOString();
  const slug    = slugInp || makeSlug(title, dateISO);

  // poszt HTML v√°z
  const html = `<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${title}</title>
  <meta name="description" content="${excerpt.replace(/"/g,'&quot;')}">
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemz√©s</span></a>
    <div class="links">
      <a href="/">Elemz√©sek</a>
      <a href="/stats.html">Statisztika</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>${title}</h1>
    <p>${new Date(dateISO).toLocaleDateString('hu-HU')} ‚Ä¢ ${league || ''}</p>
  </div>
</header>

<main>
  <article class="card">
    ${body || '<p>(Nincs tartalom)</p>'}
  </article>
</main>

<footer>
  <small>¬© 2025 <strong>SportElemz√©s</strong> ‚Ä¢ <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a></small>
</footer>
</body>
</html>`;

  const msg = $('#msg');
  try {
    // 1) poszt f√°jl
    const filePath = `posts/${slug}.html`;
    const cur = await ghGet(filePath);
    await ghPut(filePath, html, `Add post ${slug}`, cur.sha);

    // 2) index.json friss√≠t√©s
    const idx = await ghGet('posts/index.json');
    let arr = [];
    try { arr = JSON.parse(idx.content||'[]'); } catch(e){ arr = []; }
    const item = { slug, title, date: dateISO, league, excerpt };
    // ha l√©tezik m√°r, t√∂r√∂lj√ºk
    arr = arr.filter(x => x.slug !== slug);
    // el≈ëre
    arr.unshift(item);
    // opcion√°lis limit
    if (arr.length > 100) arr.length = 100;

    await ghPut('posts/index.json', JSON.stringify(arr, null, 2), 'Update posts index', idx.sha);
    msg.textContent = 'K√©sz! Cikk k√∂zz√©t√©ve.';
    alert('K√©sz!');

  } catch (e) {
    console.error(e);
    msg.textContent = 'Hiba: '+e.message;
    alert('Hiba: '+e.message);
  }
};

// ------ TIPP MENT√âS ------
function makePickId(eventId){
  const rnd = Math.random().toString(36).slice(2,8);
  return (eventId||'evt').toLowerCase().replace(/[^\w\-]+/g,'-') + '-' + rnd;
}

$('#savePick').onclick = async () => {
  const sport   = $('#p_sport').value.trim() || 'soccer_epl';
  const eventId = $('#p_event').value.trim();
  const market  = $('#p_market').value;
  const sel     = $('#p_sel').value;
  const line    = $('#p_line').value.trim();
  const odds    = parseFloat($('#p_odds').value);
  const stake   = parseFloat($('#p_stake').value);
  const status  = $('#p_status').value;
  const dt      = $('#p_dt').value;

  const msg = $('#msgPick');

  if (!eventId) { alert('Adj meg meccs / event ID-t.'); return; }
  if (!odds || !stake) { alert('Odds √©s t√©t k√∂telez≈ë.'); return; }

  const commence = dt ? new Date(dt).toISOString() : new Date().toISOString();

  const pick = {
    id: makePickId(eventId),
    sport_key: sport,
    eventId,
    market,
    selection: sel,
    line: line ? parseFloat(line) : null,
    odds, stake,
    status,
    commence_time: commence
  };

  try {
    const cur = await ghGet('data/picks.json');
    let arr = [];
    try { arr = JSON.parse(cur.content || '[]'); } catch(e){ arr = []; }
    arr.unshift(pick);
    await ghPut('data/picks.json', JSON.stringify(arr, null, 2), 'Add pick '+pick.id, cur.sha);
    msg.textContent = 'Tipp elmentve.';
    alert('Tipp elmentve.');
  } catch (e) {
    console.error(e);
    msg.textContent = 'Hiba: '+e.message;
    alert('Hiba: '+e.message);
  }
};
</script>
</body>
</html>
