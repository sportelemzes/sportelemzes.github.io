<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Statisztika – SportElemzés</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <style>
    .container{max-width:1100px;margin:0 auto;padding:20px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{font-weight:700;color:#bcd}
    tr:hover{background:rgba(255,255,255,.02)}
    .won{color:#7CFFB3;font-weight:700}
    .lost{color:#ff8a8a;font-weight:700}
    .void{color:#d7d7d7;font-weight:700}
    .open{color:#ffd27a;font-weight:700}
    .nowrap{white-space:nowrap}
    .muted{opacity:.8}
    canvas{max-width:100%;height:360px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/assets/site.js" defer></script>
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemzés</span></a>
    <div class="links">
      <a href="/">Elemzések</a>
      <a class="active" href="/stats.html">Statisztika</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>Statisztika</h1>
    <p class="muted">Havi bontású profit és minden közzétett tipp listája.</p>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Havi profit</h2>
    <canvas id="profitChart"></canvas>
    <p class="muted" id="sumline"></p>
  </section>

  <section class="card">
    <h2>Tippek</h2>
    <div style="overflow-x:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th class="nowrap">Dátum</th>
            <th>Meccs</th>
            <th>Piac</th>
            <th>Tipp</th>
            <th class="nowrap">Odds</th>
            <th class="nowrap">Tét</th>
            <th>Eredmény</th>
            <th class="nowrap">Profit</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="muted" id="note"></p>
  </section>
</main>

<footer class="muted" style="text-align:center;padding:24px 0">
  <div class="links">
    <a href="/">Elemzések</a>
    <a href="/stats.html">Statisztika</a>
    <a href="/privacy.html">Adatkezelés</a>
  </div>
  <div>© <span id="y"></span> SportElemzés • GitHub Pages</div>
</footer>

<script>
(async function(){
  const fmtDate = iso => {
    const d = new Date(iso);
    if (isNaN(d)) return '';
    return d.toLocaleDateString('hu-HU', { year:'numeric', month:'2-digit', day:'2-digit' });
  };

  const fmtHuf = n => (Math.round(n).toLocaleString('hu-HU')) + ' Ft';

  const marketPrint = (m, line) => {
    m = (m||'').toLowerCase();
    if (m === 'h2h' || m === 'moneyline') return 'H2H';
    if (m === 'totals') return 'O/U ' + (line ?? '');
    if (m.includes('asian') && typeof line !== 'undefined') {
      const ln = (line*1).toFixed(Math.abs(line)%1 ? 2 : 1).replace(/\.0$/,'');
      return 'AH ' + ln;
    }
    return m;
  };

  const selectionPrint = (s) => {
    s = (s||'').toLowerCase();
    if (s === 'home') return 'home';
    if (s === 'away') return 'away';
    if (s === 'draw') return 'draw';
    if (s === 'over') return 'over';
    if (s === 'under') return 'under';
    return s;
  };

  let rows = [];
  try {
    const r = await fetch('/data/picks.json?'+Date.now(), {cache:'no-store'});
    rows = await r.json();
  } catch (e) {
    console.error(e);
    $('#note').textContent = 'Nem sikerült betölteni a tippeket.';
    return;
  }

  // Újabb elöl
  rows.sort((a,b) => new Date(b.commence_time) - new Date(a.commence_time));

  // Táblázat
  const tbody = document.querySelector('#tbl tbody');
  let totalProfit = 0, settledProfit = 0;

  const trHtml = rows.map(p => {
    // profit számítás (ha hiányzik)
    let profit = 0;
    if (typeof p.profit === 'number') {
      profit = p.profit;
    } else if (p.status === 'won') {
      profit = (Number(p.odds) - 1) * Number(p.stake || 0);
    } else if (p.status === 'lost') {
      profit = -Number(p.stake || 0);
    } else if (p.status === 'void') {
      profit = 0;
    } else {
      profit = 0; // open
    }

    totalProfit += profit;
    if (p.status !== 'open') settledProfit += profit;

    const resClass = (p.status||'').toLowerCase();
    const resText  = resClass || '';

    return `
      <tr>
        <td class="nowrap">${fmtDate(p.commence_time)}</td>
        <td>${safe(p.eventName || p.eventId || '')}</td>
        <td>${safe(marketPrint(p.market, p.line))}</td>
        <td>${safe(selectionPrint(p.selection))}</td>
        <td class="nowrap">${Number(p.odds).toFixed(2)}</td>
        <td class="nowrap">${(p.stake||0).toLocaleString('hu-HU')}</td>
        <td class="${resClass}">${safe(resText)}</td>
        <td class="nowrap ${profit>=0?'won':'lost'}">${fmtHuf(profit)}</td>
      </tr>
    `;
  }).join('');

  tbody.innerHTML = trHtml || `<tr><td colspan="8" class="muted">Még nincs felvitt tipp.</td></tr>`;
  $('#note').textContent = `Elszámolt profit (lezárt tételek): ${fmtHuf(settledProfit)} • Összesített (lezárt + nyitott 0-val): ${fmtHuf(totalProfit)}`;

  // Havi bontás (lezárt tételek)
  const byMonth = {};
  rows.forEach(p => {
    if ((p.status||'open') === 'open') return; // nyitottak nem számítanak a havi P/L-be
    const d = new Date(p.commence_time);
    if (isNaN(d)) return;
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; // YYYY-MM
    let profit = (typeof p.profit === 'number')
      ? p.profit
      : (p.status === 'won' ? (Number(p.odds)-1)*Number(p.stake||0) : p.status==='lost' ? -Number(p.stake||0) : 0);
    byMonth[key] = (byMonth[key] || 0) + profit;
  });

  const labels = Object.keys(byMonth).sort();           // időrend
  const data    = labels.map(k => byMonth[k]);

  // Grafikon
  const ctx = document.getElementById('profitChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Havi profit (Ft)',
        data
      }]
    },
    options: {
      responsive: true,
      animation: false,
      scales: {
        y: { beginAtZero: true }
      },
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: c => ` ${fmtHuf(c.parsed.y)}`
          }
        }
      }
    }
  });

  // Összegző sor
  const sum = data.reduce((a,b)=>a+b,0);
  document.getElementById('sumline').textContent = `Összesített havi profit: ${fmtHuf(sum)} (csak lezárt tételek).`;
})();
</script>
</body>
</html>
