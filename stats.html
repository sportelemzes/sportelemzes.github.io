<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Statisztika</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <style>
    /* fejléccsúszás és igazítás javítás */
    .table.fixed { table-layout: fixed; width: 100%; }
    .table.fixed th, .table.fixed td { padding: 10px 12px; vertical-align: middle; }
    .table.fixed thead th { font-weight: 700; color: #e6e6e6; }
    .table.fixed td.num, .table.fixed th.num { text-align: right; }
    .table.fixed td.center, .table.fixed th.center { text-align: center; }

    /* a colgroup szélesség-kiosztása (desktop) */
    @media (min-width: 900px) {
      .c-date   { width: 12%; }
      .c-match  { width: 32%; }
      .c-market { width: 10%; }
      .c-tip    { width: 10%; }
      .c-odds   { width: 8%;  }
      .c-stake  { width: 8%;  }
      .c-res    { width: 10%; }
      .c-prof   { width: 10%; }
    }

    /* kisebb kijelzőkön hagyjuk rugalmasra, hogy ne törjön */
    @media (max-width: 899px) {
      .table.fixed { table-layout: auto; }
    }

    /* kártya a grafikonhoz */
    .chart-wrap {
      margin: 24px 0 8px;
      padding: 16px;
      background: #111a;
      border: 1px solid #222;
      border-radius: 12px;
    }
    .chart-title { margin: 0 0 6px; font-weight: 700; }
    #plChart { width: 100%; height: 280px; display: block; }
    .muted-small { color:#aaa; font-size: .9rem; margin-top:6px }
  </style>
</head>
<body>
<header class="header-hero">
  <nav class="hero-nav">
    <a class="brand" href="/"><span>SportElemzés</span></a>
    <div class="links">
      <a href="/">Elemzések</a>
      <a class="active" href="/stats.html">Statisztika</a>
    </div>
  </nav>
  <div class="hero-inner">
    <h1>Statisztika</h1>
    <p>Havi P/L, tippek és eredmények</p>
  </div>
</header>

<main>
  <section class="card">
    <h2>Havi P/L és tippek</h2>

    <!-- GRAFIKON -->
    <div class="chart-wrap" id="chartBox" style="display:none">
      <div class="chart-title">Havi profit/loss (oszlop) & kumulált P/L (vonal)</div>
      <canvas id="plChart"></canvas>
      <div class="muted-small">A grafikon csak a <b>lezárt</b> tippeket veszi figyelembe (ahol van számolt profit).</div>
    </div>

    <p class="muted" id="pl-note">
      Még nincs lezárt tipp – a grafikon az első lezárás után jelenik meg.
    </p>

    <!-- TÁBLÁZAT -->
    <div class="table-wrap">
      <table class="table fixed" id="tips">
        <colgroup>
          <col class="c-date" />
          <col class="c-match" />
          <col class="c-market" />
          <col class="c-tip" />
          <col class="c-odds" />
          <col class="c-stake" />
          <col class="c-res" />
          <col class="c-prof" />
        </colgroup>
        <thead>
        <tr>
          <th class="center">Dátum</th>
          <th>Meccs</th>
          <th class="center">Piac</th>
          <th class="center">Tipp</th>
          <th class="num">Odds</th>
          <th class="num">Tét</th>
          <th class="center">Eredmény</th>
          <th class="num">Profit</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="muted" id="err" style="display:none;"></p>
  </section>
</main>

<footer class="muted" style="text-align:center;padding:24px 0">
  <div class="links">
    <a href="/">Elemzések</a>
    <a href="/stats.html">Statisztika</a>
    <a href="/privacy.html">Adatkezelés</a>
  </div>
  <div>© <span id="y"></span> SportElemzés • GitHub Pages</div>
</footer>

<script>
  // év a láblécben
  document.getElementById('y').textContent = new Date().getFullYear();

  const $ = (s) => document.querySelector(s);
  const fmt = d => {
    try {
      return new Date(d).toLocaleDateString('hu-HU', { year:'numeric', month:'2-digit', day:'2-digit' });
    } catch(e) { return d || ''; }
  };

  // 3 betűs kód -> csapatnév (bővíthető)
  const TEAM = {
    ARS:'Arsenal', CHE:'Chelsea', NEW:'Newcastle', LIV:'Liverpool',
    MCI:'Man City', MUN:'Man United', TOT:'Tottenham', WHU:'West Ham',
    LEI:'Leicester', AVL:'Aston Villa', CRY:'Crystal Palace',
    LEEDS:'Leeds', BRI:'Brighton', WOL:'Wolves', EVE:'Everton'
  };

  function prettyMatch(eventId) {
    if (!eventId) return '';
    const p = (eventId + '').split('-').map(x => x.trim());
    if (p.length !== 2) return eventId;
    const home = TEAM[p[0]] || p[0];
    const away = TEAM[p[1]] || p[1];
    return `${home} – ${away}`;
  }

  function prettyMarket(p) {
    const m = (p?.market || '').toLowerCase();
    const line = p?.line ?? '';
    if (m === 'h2h')       return 'h2h';
    if (m === 'ah' || m === 'asian' || m === 'asian_handicap' || m === 'ah_0') {
      const l = (line === '' || line === null || line === undefined) ? '0' : line;
      return `AH ${l}`;
    }
    if (m === 'totals' || m === 'ou' || m === 'over_under') {
      return line !== '' ? `o/u ${line}` : 'o/u';
    }
    return p?.market || '';
  }

  function prettyTip(p) {
    const m = (p?.market || '').toLowerCase();
    const s = (p?.selection || '').toLowerCase();
    const line = p?.line ?? '';
    if (m === 'h2h') {
      if (s === 'home' || s === 'away' || s === 'draw') return s;
    }
    if (m === 'ah' || m === 'asian' || m === 'asian_handicap' || m === 'ah_0') {
      if (s === 'home' || s === 'away') return s;
    }
    if (m === 'totals' || m === 'ou' || m === 'over_under') {
      if (s === 'over' || s === 'under') return s;
      if (!s && (typeof line === 'number' || (typeof line === 'string' && line))) return 'over/under';
    }
    return s || '';
  }

  function prettyResult(p) {
    const st = (p?.status || '').toLowerCase();
    if (st === 'open' || st === '') return 'open';
    return st; // pl. won / lost / push / half_won / half_lost
  }

  function prettyProfit(p) {
    if (typeof p?.profit === 'number') return p.profit.toFixed(2);
    return '—';
  }

  async function load() {
    const $tbody = $('#tips tbody');
    const $err   = $('#err');
    const $note  = $('#pl-note');
    const $chartBox = $('#chartBox');
    const $canvas = $('#plChart');

    try {
      const res = await fetch('/data/picks.json', { cache:'no-store' });
      const arr = await res.json();

      $tbody.innerHTML = '';

      const tips = Array.isArray(arr) ? arr.slice() : [];
      // időrend (legutóbbi felül)
      tips.sort((a,b) => new Date(b.commence_time) - new Date(a.commence_time));

      if (!tips.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 8;
        td.className = 'muted';
        td.textContent = 'Még nincs rögzített tipp.';
        tr.appendChild(td);
        $tbody.appendChild(tr);
        return;
      }

      for (const p of tips) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${fmt(p.commence_time)}</td>
          <td>${prettyMatch(p.eventId)}</td>
          <td class="center">${prettyMarket(p)}</td>
          <td class="center">${prettyTip(p)}</td>
          <td class="num">${(typeof p.odds === 'number' ? p.odds.toFixed(2) : (p.odds || ''))}</td>
          <td class="num">${p.stake ?? ''}</td>
          <td class="center">${prettyResult(p)}</td>
          <td class="num">${prettyProfit(p)}</td>
        `;
        $tbody.appendChild(tr);
      }

      // ====== GRAFIKON (havi profit összeg + kumulált) ======
      const closed = tips.filter(p => typeof p.profit === 'number'); // csak lezárt
      if (closed.length) {
        // hónap kulcs: YYYY-MM
        const byMonth = new Map();
        for (const p of closed) {
          const d = new Date(p.commence_time);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          byMonth.set(key, (byMonth.get(key) || 0) + p.profit);
        }
        const labels = Array.from(byMonth.keys()).sort();
        const monthly = labels.map(k => byMonth.get(k));
        const cumulative = [];
        monthly.reduce((acc,v,i) => cumulative[i] = acc+v, 0);

        drawPLChart($canvas, labels, monthly, cumulative);
        $chartBox.style.display = '';
        $note.style.display = 'none';
      } else {
        // nincs lezárt
        $chartBox.style.display = 'none';
        $note.style.display = '';
      }

    } catch (e) {
      console.error(e);
      $err.style.display = '';
      $err.textContent = 'Nem sikerült betölteni a tippeket. (' + (e?.message || e) + ')';
    }
  }

  function drawPLChart(canvas, labels, bars, line) {
    // egyszerű, dependency-mentes canvas chart
    const DPR = window.devicePixelRatio || 1;
    const W = canvas.clientWidth || 700;
    const H = canvas.clientHeight || 280;
    canvas.width  = Math.floor(W * DPR);
    canvas.height = Math.floor(H * DPR);
    const ctx = canvas.getContext('2d');
    ctx.scale(DPR, DPR);

    // belső padding
    const left = 48, right = 18, top = 14, bottom = 48;
    const innerW = W - left - right;
    const innerH = H - top - bottom;

    // skála
    const minY = Math.min(0, ...bars, ...line);
    const maxY = Math.max(0, ...bars, ...line);
    const range = maxY - minY || 1;
    const niceStep = niceTick(range / 5);
    const yMin = Math.floor(minY / niceStep) * niceStep;
    const yMax = Math.ceil (maxY / niceStep) * niceStep;

    function yToPix(v) {
      return top + innerH * (1 - (v - yMin) / (yMax - yMin));
    }
    function xToPix(i) {
      return left + innerW * (i + 0.5) / labels.length;
    }

    // háttér
    ctx.fillStyle = '#0b0b0b';
    ctx.fillRect(0, 0, W, H);

    // rácsvonalak + y tengelyértékek
    ctx.strokeStyle = '#222';
    ctx.fillStyle = '#aaa';
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';

    for (let v = yMin; v <= yMax + 1e-9; v += niceStep) {
      const y = yToPix(v);
      ctx.beginPath();
      ctx.moveTo(left, y);
      ctx.lineTo(W - right, y);
      ctx.stroke();
      ctx.fillText(v.toFixed(0), left - 6, y);
    }

    // oszlopok
    const barW = Math.max(12, innerW / labels.length * 0.5);
    ctx.fillStyle = '#2a7bffcc';
    for (let i = 0; i < labels.length; i++) {
      const x = xToPix(i);
      const y0 = yToPix(0);
      const y1 = yToPix(bars[i]);
      ctx.fillRect(x - barW/2, Math.min(y0,y1), barW, Math.abs(y1 - y0));
    }

    // kumulált vonal
    ctx.strokeStyle = '#ffcf40';
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i = 0; i < labels.length; i++) {
      const x = xToPix(i);
      const y = yToPix(line[i]);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // x címkék
    ctx.fillStyle = '#aaa';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    for (let i = 0; i < labels.length; i++) {
      const x = xToPix(i);
      const y = H - bottom + 6;
      const lab = labels[i].replace('-', '. ');
      ctx.fillText(lab, x, y);
    }
  }

  // „szép” beosztás lépcső
  function niceTick(x){
    const pow10 = Math.pow(10, Math.floor(Math.log10(Math.abs(x)||1)));
    const n = x / pow10;
    let step;
    if (n <= 1) step = 1;
    else if (n <= 2) step = 2;
    else if (n <= 5) step = 5;
    else step = 10;
    return step * pow10;
  }

  load();
</script>
</body>
</html>
